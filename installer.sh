#!/bin/bash
set -e # –í—ã—Ö–æ–¥–∏—Ç—å –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# --- –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
print_info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}
print_success() {
    echo -e "${GREEN}[SUCCESS] $1${NC}"
}
print_warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}
print_error() {
    echo -e "${RED}[ERROR] $1${NC}"
}
print_header() {
    printf "\n%s\n" "========================================================================"
    echo -e "${CYAN}$1${NC}"
    printf "%s\n" "========================================================================"
}

# --- –ö—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä ---
clear
echo -e "${CYAN}"
cat << "EOF"
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
       ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
             Advanced TikTok Downloader Installer
EOF
echo -e "${NC}"

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ –æ—Ç —Ä—É—Ç–∞ ---
if [ "$EUID" -ne 0 ]; then
  print_error "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (sudo bash $0)"
  exit 1
fi

print_info "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç –¥–ª—è –≤–∞—Å TikTok-–±–æ—Ç–∞."
sleep 2

# --- –®–ê–ì 1: –°–ò–°–¢–ï–ú–ù–´–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ò ---
print_header "–®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (git, python, pip, curl)"
apt-get update -y
apt-get install -y git python3 python3-pip curl
print_success "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
sleep 1

# --- –®–ê–ì 2: –£–°–¢–ê–ù–û–í–ö–ê NODE.JS ---
print_header "–®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Node.js"
print_info "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ Node.js, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤..."
apt-get purge -y nodejs npm
apt-get autoremove -y
print_info "–î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π NodeSource –¥–ª—è Node.js v20.x..."
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js..."
apt-get install -y nodejs
NODE_VERSION=$(node -v)
print_success "Node.js ${NODE_VERSION} —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
sleep 1

# --- –®–ê–ì 3: –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ---
print_header "–®–∞–≥ 3: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å GitHub"
if [ -d "advanced-tiktok-downloader" ]; then
    print_warning "–ü–∞–ø–∫–∞ 'advanced-tiktok-downloader' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ."
else
    print_info "–ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
    git clone https://github.com/Rewixx-png/advanced-tiktok-downloader.git
    print_success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω."
fi
cd advanced-tiktok-downloader || exit
PROJECT_DIR=$(pwd)
sleep 1

# --- –®–ê–ì 4: –ó–ê–ü–†–ê–®–ò–í–ê–ï–ú –¢–û–ö–ï–ù–´ –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
print_header "–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
print_info "–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥–≤–∞ —Ç–æ–∫–µ–Ω–∞."

read -p "$(echo -e ${YELLOW}"–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞ (–æ—Ç BotFather): "${NC})" TELEGRAM_TOKEN
while [ -z "$TELEGRAM_TOKEN" ]; do
    print_error "–¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    read -p "$(echo -e ${YELLOW}"–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞ (–æ—Ç BotFather): "${NC})" TELEGRAM_TOKEN
done

print_info "\n–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–µ–Ω ms_token –æ—Ç TikTok. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ tiktok.com –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ."
echo "2. –ù–∞–∂–º–∏—Ç–µ F12, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞."
echo "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É 'Application' (–∏–ª–∏ '–•—Ä–∞–Ω–∏–ª–∏—â–µ')."
echo "4. –°–ª–µ–≤–∞ –≤—ã–±–µ—Ä–∏—Ç–µ 'Cookies' -> 'https://www.tiktok.com'."
echo "5. –ù–∞–π–¥–∏—Ç–µ –≤ —Å–ø–∏—Å–∫–µ 'ms_token' –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ."
read -p "$(echo -e ${YELLOW}"–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ms_token: "${NC})" MS_TOKEN
while [ -z "$MS_TOKEN" ]; do
    print_error "ms_token –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    read -p "$(echo -e ${YELLOW}"–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ms_token: "${NC})" MS_TOKEN
done
print_success "–¢–æ–∫–µ–Ω—ã –ø—Ä–∏–Ω—è—Ç—ã!"
sleep 1

# --- –®–ê–ì 5: –ù–ê–°–¢–†–û–ô–ö–ê PYTHON API ---
print_header "–®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python API"
print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Python..."
pip install -r "$PROJECT_DIR/python_api/requirements.txt"
print_info "–°–∫–∞—á–∏–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –¥–ª—è Playwright (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è)..."
python3 -m playwright install chromium
print_info "–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ .env..."
echo "MS_TOKEN=$MS_TOKEN" > "$PROJECT_DIR/python_api/.env"
print_success "Python API –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
sleep 1

# --- –®–ê–ì 6: –ù–ê–°–¢–†–û–ô–ö–ê NODE.JS –ë–û–¢–ê ---
print_header "–®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js –±–æ—Ç–∞"
print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Node.js..."
cd "$PROJECT_DIR/nodejs_bot"
npm install
print_info "–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º..."
echo "$TELEGRAM_TOKEN" > token.txt
cd "$PROJECT_DIR"
print_success "Node.js –±–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
sleep 1

# --- –®–ê–ì 7: –£–°–¢–ê–ù–û–í–ö–ê –ò –ó–ê–ü–£–°–ö –ß–ï–†–ï–ó PM2 ---
print_header "–®–∞–≥ 7: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2"
print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2..."
npm install -g pm2

# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º PATH, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–∑—É –Ω–∞—à–ª–∞ pm2
export PATH=$(npm bin -g):$PATH

print_info "–ó–∞–ø—É—Å–∫–∞–µ–º Python API –∏ Node.js –±–æ—Ç–∞..."
pm2 start "$PROJECT_DIR/python_api/api.py" --name "tiktok-api" --interpreter python3
pm2 start "$PROJECT_DIR/nodejs_bot/bot.js" --name "tiktok-bot"
print_info "–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
pm2 save
print_success "–ë–æ—Ç –∏ API —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã —á–µ—Ä–µ–∑ PM2!"
sleep 1

# --- –®–ê–ì 8: –§–ò–ù–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò ---
print_header "–£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
print_info "–í–∞—à –±–æ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ –∏–∑ TikTok –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
echo ""
echo -e "${YELLOW}--- –ö–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –±–æ—Ç–æ–º ---${NC}"
echo "–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º PM2 - —ç—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–ª–µ–¥–∏—Ç, —á—Ç–æ–±—ã –±–æ—Ç —Ä–∞–±–æ—Ç–∞–ª 24/7."
echo ""
echo -e "  ${CYAN}pm2 ls${NC}              - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–±–æ—Ç–∞ –∏ API)."
echo -e "  ${CYAN}pm2 logs tiktok-bot${NC} - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Telegram-–±–æ—Ç–∞."
echo -e "  ${CYAN}pm2 logs tiktok-api${NC} - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Python API (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)."
echo -e "  ${CYAN}pm2 restart all${NC}     - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ API."
echo -e "  ${CYAN}pm2 stop all${NC}        - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –∏ API."
echo ""
print_warning "–í–ê–ñ–ù–´–ô –ü–û–°–õ–ï–î–ù–ò–ô –®–ê–ì: –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞."
print_info "–ß—Ç–æ–±—ã –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è —Å–∞–º –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞, –≤–∞–º –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä—É—é —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PM2."
print_info "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:"
echo ""
STARTUP_COMMAND=$(pm2 startup | tail -n 1)
echo -e "${GREEN}${STARTUP_COMMAND}${NC}"
echo ""
print_info "–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–∞—à —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
echo -e "\n${GREEN}–£–¥–∞—á–∏ —Å –±–æ—Ç–æ–º, –±—Ä–æ! üòé${NC}\n"
